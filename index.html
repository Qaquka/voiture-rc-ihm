<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>IHM ESP32 – Contrôles + Caméra / Caméra seule / Aide</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af;
      --brand:#22c55e; --accent:#38bdf8; --danger:#ef4444; --warn:#f59e0b;
      --shadow:0 8px 22px rgba(0,0,0,.28);
      --radius:16px;
    }
    *{ box-sizing:border-box; }
    html,body{ margin:0; height:100%; background:linear-gradient(180deg,#0b1220,var(--bg)); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans"; }
    header{
      position:sticky; top:0; z-index:5;
      display:flex; align-items:center; gap:12px; padding:10px 12px;
      background:rgba(255,255,255,.04); border-bottom:1px solid rgba(255,255,255,.08); backdrop-filter: blur(6px);
    }
    header img.logo{ height:44px; width:auto; border-radius:8px; background:rgba(255,255,255,.04); padding:4px; }
    .title{ display:flex; flex-direction:column; line-height:1.15; }
    .title h1{ margin:0; font-size:1.02rem; }
    .title small{ color:var(--muted); }
    .tabs{ margin-left:auto; display:flex; gap:8px; flex-wrap:wrap; }
    .tabbtn, .modebtn{
      background:#0b1220; color:var(--text); border:1px solid rgba(255,255,255,.16);
      padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600;
    }
    .tabbtn.active{ border-color:var(--accent); outline:2px solid var(--accent); }
    .modebtn{ margin-left:8px; white-space:nowrap; }
    main{ max-width:1100px; margin:14px auto 18px; padding:0 12px; }
    .card{ background:linear-gradient(180deg,var(--panel),#0b1220); border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }
    .card h2{ margin:0; padding:12px 14px; font-size:1rem; font-weight:600; background:rgba(255,255,255,.04);
      border-bottom:1px solid rgba(255,255,255,.08); }
    .card .content{ padding:14px; }
    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    input[type="text"]{ background:#0b1220; border:1px solid rgba(255,255,255,.16); color:var(--text);
      border-radius:10px; padding:10px 12px; min-width:220px; outline:none; }
    button.link{ background:#0b1220; color:var(--text); border:1px solid rgba(255,255,255,.2);
      padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    button.link.primary{ border-color:var(--accent); }
    button.link.danger{ border-color:var(--danger); }
    .status{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:8px; color:var(--muted); }
    .dot{ width:10px; height:10px; border-radius:999px; background:var(--danger); box-shadow:0 0 0 2px rgba(0,0,0,.3) inset; }
    .dot.ok{ background:var(--brand); }
    .dot.warn{ background:var(--warn); }
    .muted{ color:var(--muted); }
    .stream{ width:100%; aspect-ratio:16/9; background:#000; border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,.08); position:relative; }
    .stream img{ width:100%; height:100%; object-fit:contain; display:block; background:#000; }
    .stream .alert{ position:absolute; inset:auto 8px 8px 8px; background:rgba(239,68,68,.95); color:#fff;
      border-radius:10px; padding:10px 12px; font-size:.9rem; display:none; }
    .stream.error .alert{ display:block; }
    .meta{ display:flex; gap:12px; flex-wrap:wrap; color:var(--muted); font-size:.92rem; }
    .tag{ padding:4px 8px; border:1px solid rgba(255,255,255,.08); border-radius:999px; }
    .controls{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; max-width:420px; margin:auto; }
    .btn{ user-select:none; cursor:pointer; text-align:center; border-radius:14px; padding:14px 12px; background:#111827;
      border:1px solid rgba(255,255,255,.1); box-shadow:var(--shadow); font-weight:600; transition: transform .05s ease, border-color .2s ease; }
    .btn:active{ transform: scale(.98); }
    .btn[data-dir="stop"]{ grid-column:1/-1; background:#1f2937; }
    .btn.active{ outline:2px solid var(--accent); border-color:var(--accent); }
    .view{ display:none; }
    .view.active{ display:block; }
    .stream:fullscreen{ width:100vw; height:100vh; border-radius:0; border:none; background:#000; }
    .stream:fullscreen img{ width:100%; height:100%; object-fit:contain; background:#000; }
    .stream:-webkit-full-screen{ width:100vw; height:100vh; border-radius:0; border:none; background:#000; }
    .stream:-webkit-full-screen img{ width:100%; height:100%; object-fit:contain; background:#000; }
    .foot{ text-align:center; padding:10px; color:var(--muted); font-size:.85rem;
      border-top:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.03); }
    #toast{ position: fixed; bottom: 14px; left: 50%; transform: translateX(-50%);
      display: grid; gap: 8px; z-index: 9999; width: min(92vw, 520px); }
    .toast{ border-radius: 12px; padding: 10px 12px; background: rgba(17,24,39,.95); color: #fff;
      border: 1px solid rgba(255,255,255,.12); box-shadow: var(--shadow); font-size: .95rem;
      display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .toast.ok{ background: rgba(16,185,129,.95); }
    .toast.warn{ background: rgba(245,158,11,.95); }
    .toast.err{ background: rgba(239,68,68,.95); }
    .toast button{ background: rgba(255,255,255,.15); border: none; color: #fff; padding: 6px 10px; border-radius: 8px; cursor: pointer; }
    body.mobile-mode header{ padding:8px 10px; }
    body.mobile-mode header img.logo{ height:36px; padding:3px; }
    body.mobile-mode .title h1{ font-size:.95rem; }
    body.mobile-mode .title small{ font-size:.8rem; }
    body.mobile-mode main{ max-width:100%; padding:0 8px; margin:10px auto 14px; }
    body.mobile-mode .card h2{ padding:10px 12px; font-size:.95rem; }
    body.mobile-mode .card .content{ padding:10px; }
    body.mobile-mode .row{ gap:8px; }
    body.mobile-mode #view-full .row input[type="text"]{ display:none; }
    body.mobile-mode #view-full #openCamOnly{ display:none; }
    body.mobile-mode #view-cam .row input[type="text"]{ display:none; }
    body.mobile-mode #view-full .stream{ aspect-ratio:auto; height: calc(100vh - 260px); }
    body.mobile-mode #view-cam .stream{ height: calc(100vh - 160px); }
    body.mobile-mode .tabbtn, body.mobile-mode .modebtn, body.mobile-mode button.link{ padding:10px 14px; border-radius:12px; }
    body.mobile-mode .btn{ padding:18px 14px; font-size:1.05rem; }

    .hud{
      position:absolute; bottom:0; left:0; right:0;
      display:flex; justify-content:center; gap:26px; align-items:center; flex-wrap:wrap;
      background:rgba(0,0,0,.45); border-top:1px solid rgba(255,255,255,.18);
      color:#fff; padding:10px 12px; font-weight:600; z-index:3;
    }
    .hud .label{ font-size:.8rem; opacity:.9; }
    .hud .val{ font-size:1.15rem; line-height:1; }
    .hud .unit{ font-size:.85rem; opacity:.9; }

    .gauge{ width:140px; height:90px; }
    .gauge text{ font-family:inherit; }
    .gauge .tick { stroke:#9ca3af; stroke-width:2; stroke-linecap:round; opacity:.9; }
    .gauge .tick-small { stroke-width:1.5; opacity:.7; }
    .gauge .arc-grey { stroke:#c0c4cc22; stroke-width:8; fill:none; }
    .gauge .arc-red  { stroke:#ef4444cc; stroke-width:8; fill:none; }
    .gauge .needle { stroke:#fff; stroke-width:3; stroke-linecap:round; filter: drop-shadow(0 0 2px rgba(0,0,0,.6)); }
    .gauge .hub { fill:#111827; stroke:#e5e7eb; stroke-width:2; }
    .gauge .num { fill:#cbd5e1; font-weight:700; font-size:22px; }
    .gauge .unit-label { fill:#cbd5e1; font-size:10px; font-weight:700; letter-spacing:.06em; }
    .hud .battbar{ width:46px; height:10px; border:1px solid rgba(255,255,255,.5); border-radius:3px; position:relative; overflow:hidden; }
    .hud .bfill{ position:absolute; inset:0 auto 0 0; width:0%; background:#22c55e; transition:width .2s ease, background .2s ease; }
  </style>
</head>
<body>
  <header id="appHeader">
    <img id="logo" class="logo" src="iut_univ_blanc.png" alt="Logo université" />
    <div class="title">
      <h1>IHM Voiture RC - GEII</h1>
      <small id="team">Groupe 2 Voiture RC</small>
    </div>
    <div class="tabs">
      <button id="tabFull" class="tabbtn active" data-view="full">Contrôles + Caméra</button>
      <button id="tabCam" class="tabbtn" data-view="cam">Caméra seule</button>
      <button id="tabHelp" class="tabbtn" data-view="help">Aide</button>
      <button id="btnMode" class="modebtn" title="Basculer l’affichage">Mode mobile</button>
    </div>
  </header>

  <main>
    <section id="view-full" class="view active">
      <div class="card">
        <h2>Flux vidéo</h2>
        <div class="content">
          <div class="status">
            <span>Statut :</span><span id="wsDot" class="dot"></span><span id="wsStatus">déconnecté</span>
          </div>
          <div class="stream" id="streamFullWrap">
            <div class="hud" id="hudFull" aria-live="polite">
              <svg id="gaugeFull" class="gauge" viewBox="0 0 200 130" aria-label="Compteur vitesse">
                <path class="arc-grey" d="M30,100 A80,80 0 0,1 170,100"/>
                <path class="arc-red"  d="M140,100 A80,80 0 0,1 170,100"/>
                <g id="ticksFull"></g>
                <g id="needleFull" transform="rotate(-110,100,100)">
                  <line class="needle" x1="100" y1="100" x2="100" y2="30"/>
                </g>
                <circle class="hub" cx="100" cy="100" r="6"/>
                <text id="spdNumFull" class="num" x="100" y="118" text-anchor="middle">0</text>
                <text class="unit-label" x="160" y="118">KM/H</text>
              </svg>

              <div class="battery">
                <span class="label">Batt.</span>
                <div class="battbar"><div class="bfill" id="bfill"></div></div>
                <span class="val" id="battVal">--</span><span class="unit">%</span>
              </div>

              <div class="rtt">
                <span class="label">Ping</span>
                <span class="val" id="pingVal">--</span><span class="unit">ms</span>
              </div>
            </div>
            <img id="imgFull" src="http://adresse_ESP32:81/stream" alt="Flux caméra ESP32 (MJPEG)">
            <div class="alert" id="alertFull">Flux vidéo indisponible. Vérifiez l’URL, le réseau, ou redémarrez la caméra. <button id="retryFull" class="link" style="margin-left:8px">Réessayer</button></div>
          </div>
          <div class="row" style="margin-top:10px">
            <input id="streamUrl" type="text" value="http://adresse_ESP32:81/stream" aria-label="URL flux MJPEG">
            <button id="applyStream" class="link primary">Appliquer</button>
            <button id="reloadStream" class="link">Recharger</button>
            <button id="disconnectStream" class="link danger">Déconnecter le flux</button>
            <button id="openCamOnly" class="link">Ouvrir la vue caméra seule (nouvel onglet)</button>
          </div>
          <div class="meta" style="margin-top:8px">
            <span class="tag">Touches: ↑ ↓ ← → ou ZQSD</span>
            <span class="tag">Espace = STOP</span>
            <span class="tag">Maintenir = mouvement continu</span>
          </div>
        </div>
        <div class="foot">Si le flux ne s'affiche pas, vérifiez l'URL MJPEG (ex. <code>http://192.168.4.1:81/stream</code>).</div>
      </div>

      <div class="card" style="margin-top:14px">
        <h2>Contrôle de la voiture</h2>
        <div class="content">
          <div class="row" style="margin-bottom:10px">
            <input id="wsUrl" type="text" value="ws://adresse_ESP32/ws" aria-label="URL WebSocket">
            <input id="httpBase" type="text" value="http://adresse_ESP32" aria-label="Base HTTP">
            <button id="btnConnect" class="link primary">Connexion </button>
            <button id="btnDisconnect" class="link">Déconnexion</button>
            <button id="btnPing" class="link">Ping</button>
            <button id="btnStop" class="link danger">STOP</button>
          </div>

          <div class="controls" aria-label="Boutons de direction">
            <div></div>
            <div class="btn" data-dir="forward" aria-label="Avancer (↑ / Z)">↑ / Z</div>
            <div></div>

            <div class="btn" data-dir="left" aria-label="Gauche (← / Q)">← / Q</div>
            <div class="btn" data-dir="backward" aria-label="Reculer (↓ / S)">↓ / S</div>
            <div class="btn" data-dir="right" aria-label="Droite (→ / D)">→ / D</div>

            <div></div>
            <div class="btn" data-dir="stop" aria-label="Stop (Espace)">STOP</div>
            <div></div>
          </div>
        </div>
        <div class="foot">Fallback HTTP automatique si WS indisponible : <code>/cmd?c=F|B|L|R|S</code>.</div>
      </div>
    </section>

    <section id="view-cam" class="view">
      <div class="card">
        <h2>Caméra seule (vue mobile)</h2>
        <div class="content">
          <div class="row">
            <div class="muted">Plein écran vidéo + anti-veille pour smartphone :</div>
            <div class="tools">
              <button id="btnFS" class="link">Plein écran vidéo</button>
              <button id="btnWake" class="link">Anti-veille</button>
              <button id="btnReload" class="link">Recharger</button>
            </div>
          </div>
          <div class="stream" id="streamCamWrap" style="margin-top:10px">
            <div class="hud" id="hudCam" aria-live="polite">
              <svg id="gaugeCam" class="gauge" viewBox="0 0 200 130" aria-label="Compteur vitesse">
                <path class="arc-grey" d="M30,100 A80,80 0 0,1 170,100"/>
                <path class="arc-red"  d="M140,100 A80,80 0 0,1 170,100"/>
                <g id="ticksCam"></g>
                <g id="needleCam" transform="rotate(-110,100,100)">
                  <line class="needle" x1="100" y1="100" x2="100" y2="30"/>
                </g>
                <circle class="hub" cx="100" cy="100" r="6"/>
                <text id="spdNumCam" class="num" x="100" y="118" text-anchor="middle">0</text>
                <text class="unit-label" x="160" y="118">KM/H</text>
              </svg>

              <div class="battery">
                <span class="label">Batt.</span>
                <div class="battbar"><div class="bfill" id="bfillCam"></div></div>
                <span class="val" id="battValCam">--</span><span class="unit">%</span>
              </div>

              <div class="rtt">
                <span class="label">Ping</span>
                <span class="val" id="pingValCam">--</span><span class="unit">ms</span>
              </div>
            </div>

            <img id="imgCam" src="http://adresse_ESP32:81/stream" alt="Flux caméra ESP32 (MJPEG)">
            <div class="alert" id="alertCam">Flux vidéo indisponible. Vérifiez l’URL, le réseau, ou redémarrez la caméra. <button id="retryCam" class="link" style="margin-left:8px">Réessayer</button></div>
          </div>

          <div class="row" style="margin-top:10px">
            <input id="streamUrlCam" type="text" value="http://adresse_ESP32:81/stream" aria-label="URL flux MJPEG (caméra seule)">
            <button id="applyStreamCam" class="link primary">Appliquer</button>
            <button id="reloadStreamCam" class="link">Recharger</button>
            <button id="disconnectStreamCam" class="link danger">Déconnecter le flux</button>
          </div>
        </div>
        <div class="foot">Astuce : tournez le téléphone en paysage pour une meilleure visibilité. Le plein écran est demandé uniquement pour l’élément vidéo.</div>
      </div>
    </section>

    <section id="view-help" class="view help">
      <div class="card">
        <h2>Aide – Mise en route & utilisation</h2>
        <div class="content">
          <ol>
            <li><strong>Connectez-vous au réseau de l’ESP32</strong> (AP <code>192.168.4.1</code> ou votre réseau local).</li>
            <li><strong>Ouvrez ce fichier</strong> sur votre navigateur (PC ou smartphone).</li>
            <li>Dans l’onglet <em>Contrôles + Caméra</em>, entrez :
              <ul>
                <li><strong>Flux MJPEG</strong> : ex. <code>http://192.168.4.1:81/stream</code>.</li>
                <li><strong>WebSocket</strong> : ex. <code>ws://192.168.4.1/ws</code> (si disponible).</li>
                <li><strong>Base HTTP</strong> : ex. <code>http://192.168.4.1</code> (fallback).</li>
              </ul>
            </li>
            <li>Cliquez <strong>Connexion</strong> (facultatif). Sinon, les commandes passent en <em>HTTP</em> (GET <code>/cmd?c=F|B|L|R|S</code>).</li>
            <li><strong>Contrôles</strong> : flèches ou ZQSD ; <code>Espace</code>=STOP. Maintenir pour mouvement continu.</li>
            <li>Pour une vue pilote sur smartphone : onglet <em>Caméra seule</em> → <em>Plein écran vidéo</em> + <em>Anti-veille</em>.</li>
          </ol>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" aria-live="polite" aria-atomic="true"></div>

  <script>
    const $=(s,r=document)=>r.querySelector(s);
    const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const qp=new URLSearchParams(location.search);
    const DEFAULTS={
      STREAM_URL:"http://webcam.privcom.ch/mjpg/video.mjpg",
      WS_URL:"ws://adresse_ESP32/ws",
      HTTP_BASE:"http://adresse_ESP32",
      LOGO_URL:"iut_univ_blanc.png",
      TEAM_TXT:"Groupe 2 Voiture RC"
    };

    function notify(msg, level="err", actions=[]){
      const wrap=$("#toast");
      const el=document.createElement("div");
      el.className=`toast ${level}`;
      const btns = actions.map(a=>`<button data-act="${a.id||'act'}">${a.label}</button>`).join("");
      el.innerHTML=`<span>${msg}</span><span>${btns}</span>`;
      wrap.appendChild(el);
      actions.forEach(a=>{
        const b = el.querySelector(`button[data-act="${a.id||'act'}"]`);
        if(b) b.addEventListener("click", ()=>{ try{ a.onClick?.(); }catch{}; el.remove(); });
      });
      setTimeout(()=>{ try{ el.remove(); }catch{}; }, 4000);
    }

    const param = (key, fallback)=> qp.get(key) || fallback;

    const logoEl=$("#logo"), teamEl=$("#team");
    logoEl.src = param("logo", DEFAULTS.LOGO_URL);
    logoEl.addEventListener("error", ()=>{
      if (!logoEl.dataset.fallback){
        logoEl.dataset.fallback = "1";
        logoEl.src = "iut_univ_blanc.png";
      }
    });
    teamEl.textContent = "Équipe : " + decodeURIComponent(param("team", encodeURIComponent(DEFAULTS.TEAM_TXT)));

    const tabFull=$("#tabFull"), tabCam=$("#tabCam"), tabHelp=$("#tabHelp");
    const viewFull=$("#view-full"), viewCam=$("#view-cam"), viewHelp=$("#view-help");
    function setView(v){
      const isFull = v==="full", isCam = v==="cam", isHelp = v==="help";
      viewFull.classList.toggle("active", isFull);
      viewCam.classList.toggle("active", isCam);
      viewHelp.classList.toggle("active", isHelp);
      tabFull.classList.toggle("active", isFull);
      tabCam.classList.toggle("active", isCam);
      tabHelp.classList.toggle("active", isHelp);
      const url=new URL(location.href); url.searchParams.set("view", v); history.replaceState(null,"",url);
      if(isCam){ attemptVideoFullscreen(); }
    }
    setView(param("view","full"));
    tabFull.addEventListener("click", ()=>setView("full"));
    tabCam.addEventListener("click",  ()=>setView("cam"));
    tabHelp.addEventListener("click", ()=>setView("help"));

    const btnMode = $("#btnMode");
    function setUIMode(mode){
      const isMobile = (mode === "mobile");
      document.body.classList.toggle("mobile-mode", isMobile);
      btnMode.textContent = isMobile ? "Mode desktop" : "Mode mobile";
      const url=new URL(location.href);
      url.searchParams.set("mode", isMobile ? "mobile" : "desktop");
      history.replaceState(null,"",url);
      try{ localStorage.setItem("uiMode", isMobile ? "mobile":"desktop"); }catch{}
    }
    (function initMode(){
      const fromQP = qp.get("mode");
      if(fromQP){ setUIMode(fromQP); return; }
      try{ const saved = localStorage.getItem("uiMode"); if(saved) setUIMode(saved); }catch{}
    })();
    btnMode.addEventListener("click", ()=>{
      const isMobile = document.body.classList.contains("mobile-mode");
      setUIMode(isMobile ? "desktop" : "mobile");
    });

    const imgFull=$("#imgFull"), imgCam=$("#imgCam");
    const streamUrl=$("#streamUrl"), streamUrlCam=$("#streamUrlCam");
    const applyStream=$("#applyStream"), reloadStream=$("#reloadStream");
    const applyStreamCam=$("#applyStreamCam"), reloadStreamCam=$("#reloadStreamCam");
    const streamFullWrap=$("#streamFullWrap"), streamCamWrap=$("#streamCamWrap");
    const retryFull=$("#retryFull"), retryCam=$("#retryCam");
    const btnDisconnectStream = $("#disconnectStream");
    const btnDisconnectStreamCam = $("#disconnectStreamCam");

    const streamDefault = param("stream", DEFAULTS.STREAM_URL);
    setStream(streamDefault);

    function setStream(url){
      imgFull.src = url; imgCam.src = url;
      streamUrl.value = url; streamUrlCam.value = url;
      clearStreamError(true); clearStreamError(false);
    }
    function reloadImg(img){
      try{
        const u=new URL(img.src, location.href);
        u.searchParams.set("_", Date.now());
        img.src=u.toString();
      }catch{}
    }
    function showStreamError(full, message){
      const wrap = full ? streamFullWrap : streamCamWrap;
      wrap.classList.add("error");
      const alert = full ? $("#alertFull") : $("#alertCam");
      alert.firstChild.textContent = message || "Flux vidéo indisponible.";
    }
    function clearStreamError(full){
      const wrap = full ? streamFullWrap : streamCamWrap;
      wrap.classList.remove("error");
    }
    imgFull.addEventListener("error", ()=>{
      showStreamError(true, "Flux vidéo indisponible (URL invalide, caméra arrêtée ou réseau HS).");
      notify("Erreur flux vidéo (vue complète). Vérifiez l’URL ou la connexion.", "err", [{id:"r",label:"Réessayer",onClick:()=>reloadImg(imgFull)}]);
    });
    imgCam.addEventListener("error", ()=>{
      showStreamError(false, "Flux vidéo indisponible (URL invalide, caméra arrêtée ou réseau HS).");
      notify("Erreur flux vidéo (vue caméra). Vérifiez l’URL ou la connexion.", "err", [{id:"r",label:"Réessayer",onClick:()=>reloadImg(imgCam)}]);
    });
    imgFull.addEventListener("load", ()=> clearStreamError(true));
    imgCam.addEventListener("load",  ()=> clearStreamError(false));
    applyStream.addEventListener("click", ()=>{
      const u=(streamUrl.value||"").trim();
      if(u){ setStream(u); } else { notify("URL de flux vide.", "warn"); }
    });
    reloadStream.addEventListener("click", ()=> reloadImg(imgFull));
    applyStreamCam.addEventListener("click", ()=>{
      const u=(streamUrlCam.value||"").trim();
      if(u){ setStream(u); } else { notify("URL de flux vide.", "warn"); }
    });
    reloadStreamCam.addEventListener("click", ()=> reloadImg(imgCam));
    retryFull.addEventListener("click", ()=> reloadImg(imgFull));
    retryCam.addEventListener("click",  ()=> reloadImg(imgCam));

    function disconnectStream(img, full){
      try{ img.src = ""; }catch{}
      const wrap  = full ? streamFullWrap : streamCamWrap;
      const alert = full ? $("#alertFull") : $("#alertCam");
      if (wrap)  wrap.classList.add("error");
      if (alert) alert.firstChild.textContent = "Flux déconnecté par l’utilisateur.";
      notify("Flux vidéo déconnecté.", "warn");
    }
    if (btnDisconnectStream)    btnDisconnectStream.addEventListener("click", ()=> disconnectStream(imgFull, true));
    if (btnDisconnectStreamCam) btnDisconnectStreamCam.addEventListener("click", ()=> disconnectStream(imgCam,  false));

    $("#openCamOnly").addEventListener("click", ()=>{
      const u = (streamUrl.value||DEFAULTS.STREAM_URL).trim();
      const url = `${location.pathname}?view=cam&stream=${encodeURIComponent(u)}&logo=${encodeURIComponent(logoEl.src)}&team=${encodeURIComponent(teamEl.textContent.replace(/^Équipe :\\s*/,''))}`;
      window.open(url, "_blank");
    });

    const wsUrlEl=$("#wsUrl"), httpBaseEl=$("#httpBase");
    const btnConnect=$("#btnConnect"), btnDisconnect=$("#btnDisconnect");
    const btnPing=$("#btnPing"), btnStop=$("#btnStop");
    const wsDot=$("#wsDot"), wsStatus=$("#wsStatus");
    wsUrlEl.value = param("ws", DEFAULTS.WS_URL);
    httpBaseEl.value = param("http", DEFAULTS.HTTP_BASE);

    let ws=null;
    let lastPingAt = null;

    const setWsStatus=(open,txt,level)=>{
      wsDot.classList.remove("warn","ok");
      wsDot.classList.toggle("ok",!!open);
      if(level==="warn") wsDot.classList.add("warn");
      wsStatus.textContent=txt || (open?"connecté":"déconnecté");
    };

    function connectWS(){
      const url=wsUrlEl.value.trim();
      if(!/^wss?:\/\//i.test(url)){ notify("URL WebSocket invalide (ex: ws://192.168.4.1/ws)", "warn"); return; }
      try{ if(ws&&ws.readyState===WebSocket.OPEN) ws.close(); }catch{}
      setWsStatus(false,"connexion…","warn");
      try{ ws=new WebSocket(url); }
      catch(e){ notify("Échec d’ouverture WebSocket (URL invalide ?)", "err"); setWsStatus(false,"erreur"); return; }

      ws.addEventListener("open", ()=>{ setWsStatus(true,"connecté"); notify("WebSocket connectée.", "ok"); });
      ws.addEventListener("close",()=>{ setWsStatus(false,"déconnecté"); notify("WebSocket déconnectée.", "warn"); });
      ws.addEventListener("error",()=>{ setWsStatus(false,"erreur"); notify("Erreur WebSocket (réseau / serveur).", "err"); });

      ws.addEventListener("message",(ev)=>{
        try{
          let payload = {};
          try{
            const obj = JSON.parse(ev.data);
            if(obj && typeof obj === "object") payload = obj;
          }catch{
            const s = String(ev.data).trim();
            const mSpd = s.match(/^SPD\s*:\s*([+-]?\d+(?:\.\d+)?)$/i);
            const mBat = s.match(/^BATT\s*:\s*([+-]?\d+(?:\.\d+)?)$/i);
            const mPing= s.match(/^PING\s*:\s*([+-]?\d+(?:\.\d+)?)$/i);
            if(mSpd) payload.speed = parseFloat(mSpd[1]);
            if(mBat) payload.battery = parseFloat(mBat[1]);
            if(mPing) payload.ping = parseFloat(mPing[1]);
            if(/^PONG(?:[:\s]\d+)?$/i.test(s) && lastPingAt!=null){
              const rtt = Math.round(performance.now() - lastPingAt);
              updatePing(rtt);
              lastPingAt=null;
            }
          }
          if("speed" in payload)   updateSpeed(payload.speed);
          if("battery" in payload) updateBattery(payload.battery);
          if("ping" in payload)    updatePing(payload.ping);
        }catch{}
      });
    }
    function disconnectWS(){ try{ ws&&ws.close(); }catch{} setWsStatus(false,"déconnecté"); notify("WebSocket déconnectée.", "warn"); }
    async function sendOverHTTP(cmd){
      const base=httpBaseEl.value.trim().replace(/\/+$/,"");
      if(!/^https?:\/\//i.test(base)){ notify("Base HTTP invalide (ex: http://192.168.4.1)", "warn"); return; }
      try{
        const res = await fetch(`${base}/cmd?c=${encodeURIComponent(cmd)}`,{cache:"no-store"});
        if(!res.ok){ notify(`HTTP ${res.status} lors de l'envoi de la commande.`, "warn"); }
        else{ notify("Commande envoyée (HTTP).", "ok"); }
      }catch{ notify("Erreur réseau HTTP (commande non envoyée).", "err"); }
    }
    function sendCommand(cmd){
      if(ws&&ws.readyState===WebSocket.OPEN){
        try{ ws.send(cmd); notify("Commande envoyée (WS).", "ok"); return; }catch{ notify("Échec envoi WS, bascule HTTP.", "warn"); }
      }
      sendOverHTTP(cmd);
    }
    btnConnect.addEventListener("click", connectWS);
    btnDisconnect.addEventListener("click", disconnectWS);
    btnPing.addEventListener("click", ()=>{
      if(ws && ws.readyState===WebSocket.OPEN){
        lastPingAt = performance.now();
        try{ ws.send("PING"); }catch{}
      }else{
        notify("WS non connecté : impossible de mesurer le ping (RTT).", "warn");
      }
    });
    btnStop.addEventListener("click", ()=> sendCommand("S"));

    const pressed=new Set();
    const KeyMap={"ArrowUp":"F","KeyZ":"F","ArrowDown":"B","KeyS":"B","ArrowLeft":"L","KeyQ":"L","ArrowRight":"R","KeyD":"R","Space":"S"};
    function handleKey(code, down){
      if(!(code in KeyMap)) return;
      const cmd = KeyMap[code];
      if(cmd==="S"){ sendCommand("S"); return; }
      if(down){ sendCommand(cmd); } else { sendCommand("S"); }
    }
    window.addEventListener("keydown",(e)=>{
      const c=e.code; if(!(c in KeyMap)) return;
      if(!viewFull.classList.contains("active")) return;
      e.preventDefault(); if(pressed.has(c)) return; pressed.add(c); handleKey(c,true);
    },{passive:false});
    window.addEventListener("keyup",(e)=>{
      const c=e.code; if(!(c in KeyMap)) return;
      if(!viewFull.classList.contains("active")) return;
      e.preventDefault(); pressed.delete(c); handleKey(c,false);
    },{passive:false});
    window.addEventListener("blur", ()=> sendCommand("S"));
    document.addEventListener("visibilitychange", ()=>{ if(document.hidden) sendCommand("S"); });

    const btnFS=$("#btnFS"), btnWake=$("#btnWake"), btnReload=$("#btnReload");
    function requestFullscreenOn(el){
      if(!el) return;
      if (el.requestFullscreen) { el.requestFullscreen().catch(()=>{}); return; }
      if (el.webkitRequestFullscreen) { try{ el.webkitRequestFullscreen(); }catch{} }
    }
    if(btnFS){
      btnFS.addEventListener("click", ()=>{
        requestFullscreenOn(document.getElementById("streamCamWrap"));
        enableWakeLock();
      });
    }
    if(btnReload){ btnReload.addEventListener("click", ()=> reloadImg(imgCam)); }
    let wakeLock=null;
    async function enableWakeLock(){
      try{
        if(!wakeLock){
          wakeLock = await navigator.wakeLock.request("screen");
          notify("Anti-veille activé (si supporté).", "ok");
          wakeLock.addEventListener("release", ()=>{ wakeLock=null; notify("Anti-veille relâché.", "warn"); });
        }
      }catch{}
    }
    async function attemptVideoFullscreen(fromButton=false){
      const wrap = document.getElementById("streamCamWrap");
      if(!wrap) return;
      try{
        if(document.fullscreenElement !== wrap){
          if (wrap.requestFullscreen) { await wrap.requestFullscreen(); }
          else if (wrap.webkitRequestFullscreen) { wrap.webkitRequestFullscreen(); }
          if(!fromButton) notify("Plein écran (HUD) demandé.", "ok");
        }
      }catch{}
      enableWakeLock();
    }

    const battVal = $("#battVal"), battValCam = $("#battValCam");
    const bfill = $("#bfill"), bfillCam = $("#bfillCam");
    const pingVal = $("#pingVal"), pingValCam = $("#pingValCam");

    const needleFull = $("#needleFull"), needleCam = $("#needleCam");
    const spdNumFull = $("#spdNumFull"), spdNumCam = $("#spdNumCam");
    const ticksFullG = $("#ticksFull"), ticksCamG = $("#ticksCam");

    const MAX_SPEED = 100;
    const START_ANGLE = -110;
    const END_ANGLE   = 110;

    function buildTicks(container){
      container.innerHTML = "";
      for(let i=0;i<=10;i++){
        const angle = START_ANGLE + (END_ANGLE-START_ANGLE)*(i/10);
        const r1 = 80, r2 = 72;
        const x1 = 100 + r1*Math.cos(angle*Math.PI/180);
        const y1 = 100 + r1*Math.sin(angle*Math.PI/180);
        const x2 = 100 + r2*Math.cos(angle*Math.PI/180);
        const y2 = 100 + r2*Math.sin(angle*Math.PI/180);
        const l = document.createElementNS("http://www.w3.org/2000/svg","line");
        l.setAttribute("x1",x1.toFixed(1)); l.setAttribute("y1",y1.toFixed(1));
        l.setAttribute("x2",x2.toFixed(1)); l.setAttribute("y2",y2.toFixed(1));
        l.setAttribute("class","tick");
        container.appendChild(l);

        if(i<10){
          for(let s=1;s<=2;s++){
            const f = (i + s/3)/10;
            const a = START_ANGLE + (END_ANGLE-START_ANGLE)*f;
            const rx1=80, rx2=75;
            const sx1 = 100 + rx1*Math.cos(a*Math.PI/180);
            const sy1 = 100 + rx1*Math.sin(a*Math.PI/180);
            const sx2 = 100 + rx2*Math.cos(a*Math.PI/180);
            const sy2 = 100 + rx2*Math.sin(a*Math.PI/180);
            const sl = document.createElementNS("http://www.w3.org/2000/svg","line");
            sl.setAttribute("x1",sx1.toFixed(1)); sl.setAttribute("y1",sy1.toFixed(1));
            sl.setAttribute("x2",sx2.toFixed(1)); sl.setAttribute("y2",sy2.toFixed(1));
            sl.setAttribute("class","tick tick-small");
            container.appendChild(sl);
          }
        }
      }
    }
    buildTicks(ticksFullG); buildTicks(ticksCamG);

    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function updateSpeed(v){
      const n = Number.isFinite(v) ? v : 0;
      const s = clamp(n, 0, MAX_SPEED);
      const t = (s / MAX_SPEED);
      const ang = START_ANGLE + (END_ANGLE-START_ANGLE) * t;

      if(needleFull) needleFull.setAttribute("transform", `rotate(${ang},100,100)`);
      if(needleCam)  needleCam.setAttribute("transform",  `rotate(${ang},100,100)`);
      if(spdNumFull) spdNumFull.textContent = Math.round(n).toString().padStart(2,"0");
      if(spdNumCam)  spdNumCam.textContent  = Math.round(n).toString().padStart(2,"0");
    }

    function updateBattery(pct){
      if(!Number.isFinite(pct)) return;
      const n = clamp(pct, 0, 100);
      const w = `${n}%`;
      const col = n<20?'#ef4444':(n<50?'#f59e0b':'#22c55e');
      if(battVal) battVal.textContent = String(Math.round(n));
      if(battValCam) battValCam.textContent = String(Math.round(n));
      if(bfill){ bfill.style.width = w; bfill.style.background = col; }
      if(bfillCam){ bfillCam.style.width = w; bfillCam.style.background = col; }
    }

    function updatePing(ms){
      if(!Number.isFinite(ms)) return;
      const n = Math.max(0, Math.round(ms));
      if(pingVal) pingVal.textContent = String(n);
      if(pingValCam) pingValCam.textContent = String(n);
    }
  </script>
</body>
</html>
